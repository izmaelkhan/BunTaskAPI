<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bun Task API â€” Demo</title>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 900px; 
      margin: 40px auto; 
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    #search {
      width: 260px;
      padding: 8px;
      font-size: 16px;
    }

    input, textarea, button {
      padding: 8px;
      font-size: 16px;
      margin-top: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    textarea { resize: vertical; }

    .task {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    .task-date {
      color: #888;
      font-size: 14px;
      white-space: nowrap;
      margin-left: 10px;
    }

    .description { 
      color: #666; 
      margin-top: 4px; 
    }

    .summary { 
      color: #444; 
      margin-top: 6px; 
      font-style: italic; 
    }

    .loading {
      color: blue;
      font-style: italic;
    }
    .refresh-summary{
      width:32px; 
      height:32px; 
      border-radius:50%;
      display:flex; 
      align-items:center; 
      justify-content:center;
      font-size:16px; 
      cursor:pointer;
    }
    .delete-task{
      width:32px;   
      height:32px;
      border-radius:50%;
      background:#d9534f; 
      color:white;
      display:flex; 
      align-items:center; 
      justify-content:center;
      font-size:16px; 
      cursor:pointer;
    }
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      padding: 10px 16px;
      border-radius: 4px;
      display: none;
      font-size: 15px;
    }
  </style>
</head>

<body>

<div id="notification"></div>

<div class="header-bar">
  <h1>Bun Task API â€” Demo</h1>
  <input id="search" placeholder="Search tasks..." />
</div>

<p>Create a task with title & description; an AI generates a short summary automatically.</p>

<div>
  <input id="title" placeholder="Task title" />
  <textarea id="description" placeholder="Task description" rows="3"></textarea>
  <button id="create">Create</button>
</div>

<h2>Tasks</h2>
<div id="tasks"></div>

<script>
  let currentPage = 1;
  const limit = 10;
  let loading = false;

  async function fetchTasks(query = "", page = 1) {
    loading = true;

    const url = `/tasks?page=${page}&limit=${limit}` +
      (query ? `&query=${encodeURIComponent(query)}` : "");

    const res = await fetch(url);
    const json = await res.json();

    const container = document.getElementById("tasks");
    if (page === 1) container.innerHTML = ""; // clear on new search

    json.forEach(t => {
      const el = document.createElement("div");
      el.className = "task";

      el.innerHTML = `
        <div class="task-header">
          <div><strong>#${t.id}</strong> ${t.title}</div>
          <div class="task-date">${new Date(t.created_at).toLocaleDateString()}</div>
        </div>

        ${t.description ? `<div class="description">${t.description}</div>` : ""}

        <div class="summary" id="summary-${t.id}">
          ${t.summary ?? "â€” awaiting summary â€”"}
        </div>

        <div style="margin-top:8px; display:flex; gap:8px;">
          <button class="refresh-summary" data-id="${t.id}">
            ðŸ”„
          </button>

          <button class="delete-task" data-id="${t.id}">
            ðŸ—‘
          </button>
        </div>
      `;


      container.appendChild(el);
    });

    // Refresh Summary Actions
document.querySelectorAll(".refresh-summary").forEach(btn => {
  btn.onclick = async () => {
    const id = btn.getAttribute("data-id");

    // 1. Store scroll position of the task
    const taskElement = btn.closest(".task");
    const offset = taskElement.getBoundingClientRect().top;

    // 2. Show loading text
    const summaryDiv = document.getElementById(`summary-${id}`);
    summaryDiv.innerHTML = '<span class="loading">Refreshing summary...</span>';

    // 3. Call the API
    await fetch(`/task/${id}/refresh-summary`, { method: "POST" });

    // 4. Reload tasks
    await fetchTasks(document.getElementById("search").value, 1);

    // 5. Scroll back to the same task
    const updatedTask = document.querySelector(`button.refresh-summary[data-id="${id}"]`);
    if (updatedTask) {
      const newTop = updatedTask.closest(".task").getBoundingClientRect().top;
      window.scrollBy(0, newTop - offset);
    }
  };
});


    // Delete Actions
    document.querySelectorAll(".delete-task").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");

        if (!confirm("Are you sure you want to delete this task?")) return;

        const res = await fetch(`/task/${id}`, { method: "DELETE" });

        if (res.ok) {
          showNotification("Task deleted successfully");
          fetchTasks(document.getElementById("search").value, 1);
        }
      };
    });

    loading = false;
  }

  // Search
  document.getElementById("search").addEventListener("input", e => {
    currentPage = 1;
    fetchTasks(e.target.value.trim(), currentPage);
  });

  // Create Task
  document.getElementById("create").onclick = async () => {
    const title = document.getElementById("title").value.trim();
    const description = document.getElementById("description").value.trim();

    if (!title) return alert("Enter a title");

    await fetch("/task", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, description })
    });

    document.getElementById("title").value = "";
    document.getElementById("description").value = "";

    currentPage = 1;
    fetchTasks();
  };

  // Infinite Scroll
  window.addEventListener("scroll", () => {
    if (loading) return;

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 150) {
      currentPage++;
      fetchTasks(document.getElementById("search").value, currentPage);
    }
  });

  function showNotification(msg) {
    const n = document.getElementById("notification");
    n.innerText = msg;
    n.style.display = "block";
    setTimeout(() => n.style.display = "none", 2000);
  }

  // Initial Load
  fetchTasks();
</script>

</body>
</html>
